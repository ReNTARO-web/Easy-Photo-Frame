<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>写真フレームエディタ</title>
  <!-- React 17 & Babel -->
  <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- html2canvas -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", "Segoe UI", sans-serif; }
    .draggable { position:absolute; cursor:move; }
    .resize-handle { width:10px;height:10px;background:#2563eb;position:absolute;right:-5px;bottom:-5px;cursor:se-resize; }
    .editable-text { white-space: pre-wrap; }
  </style>
</head>
<body class="bg-gray-100">
  <div id="root"></div>

  <script type="text/babel">

    const { useState, useRef, useEffect } = React;

    const aspectRatios = {
      "Instagram (1:1)": [600, 600],
      "Twitter (16:9)": [960, 540],
      "YouTube (1280×720)": [1280, 720],
      "Facebook (1200×630)": [1200, 630],
    };

    function App(){
      const [ratio,setRatio] = useState("Instagram (1:1)");
      const [objects,setObjects] = useState([
        {id:1,type:"text",content:"ダブルクリックで編集",x:50,y:50,w:200,h:40}
      ]);
      const [editingId,setEditingId] = useState(null);
      const [selectedIds,setSelectedIds] = useState([]);
      const containerRef = useRef(null);
      const [cw,ch] = aspectRatios[ratio];

      // 移動
      const onDrag = (id,e) => {
        const startX = e.clientX;
        const startY = e.clientY;
        const obj = objects.find(o=>o.id===id);
        const initX = obj.x;
        const initY = obj.y;
        const move = (ev)=>{
          const dx = ev.clientX - startX;
          const dy = ev.clientY - startY;
          setObjects(prev => prev.map(o=>o.id===id?{...o,x:initX+dx,y:initY+dy}:o));
        };
        const up = ()=>{
          window.removeEventListener("mousemove",move);
          window.removeEventListener("mouseup",up);
        };
        window.addEventListener("mousemove",move);
        window.addEventListener("mouseup",up);
      };

      // サイズ変更
      const onResize = (id,e)=>{
        e.stopPropagation();
        const startX = e.clientX;
        const startY = e.clientY;
        const obj = objects.find(o=>o.id===id);
        const initW = obj.w;
        const initH = obj.h;
        const move = (ev)=>{
          const dw = ev.clientX - startX;
          const dh = ev.clientY - startY;
          setObjects(prev=>prev.map(o=>o.id===id?{...o,w:Math.max(30,initW+dw),h:Math.max(20,initH+dh)}:o));
        };
        const up = ()=>{
          window.removeEventListener("mousemove",move);
          window.removeEventListener("mouseup",up);
        };
        window.addEventListener("mousemove",move);
        window.addEventListener("mouseup",up);
      };

      // 整列
      const align = (mode)=>{
        if(selectedIds.length===0) return;
        if(mode==="centerX"){
          setObjects(prev=>prev.map(o=>selectedIds.includes(o.id)?{...o,x:cw/2 - o.w/2}:o));
        } else if(mode==="centerY"){
          setObjects(prev=>prev.map(o=>selectedIds.includes(o.id)?{...o,y:ch/2 - o.h/2}:o));
        } else if(mode==="left"){
          setObjects(prev=>prev.map(o=>selectedIds.includes(o.id)?{...o,x:0}:o));
        } else if(mode==="right"){
          setObjects(prev=>prev.map(o=>selectedIds.includes(o.id)?{...o,x:cw-o.w}:o));
        }
      };

      // 保存
      const saveAsImage = async ()=>{
        const canvas = await html2canvas(containerRef.current,{scale:2});
        const link = document.createElement("a");
        link.download="workspace.png";
        link.href = canvas.toDataURL("image/png");
        link.click();
      };

      return (
        <div className="flex flex-col items-center p-4 space-y-2">
          <h1 className="text-xl font-bold">📸 写真フレームエディタ</h1>
          <div className="flex gap-2">
            {Object.keys(aspectRatios).map(r=>(
              <button key={r} onClick={()=>setRatio(r)} className={`px-2 py-1 ${r===ratio?"bg-blue-500 text-white":"bg-gray-200"}`}>
                {r}
              </button>
            ))}
          </div>
          <div className="flex gap-2">
            <button onClick={()=>align("centerX")} className="px-2 py-1 bg-gray-200">中央横揃え</button>
            <button onClick={()=>align("centerY")} className="px-2 py-1 bg-gray-200">中央縦揃え</button>
            <button onClick={()=>align("left")} className="px-2 py-1 bg-gray-200">左揃え</button>
            <button onClick={()=>align("right")} className="px-2 py-1 bg-gray-200">右揃え</button>
          </div>
          <button onClick={saveAsImage} className="px-3 py-1 bg-green-500 text-white">保存</button>

          <div ref={containerRef} className="relative bg-white border shadow"
            style={{width:cw,height:ch}}>
            {objects.map(o=>(
              editingId===o.id ? (
                <textarea key={o.id} autoFocus value={o.content}
                  onChange={(e)=>setObjects(prev=>prev.map(x=>x.id===o.id?{...x,content:e.target.value}:x))}
                  onBlur={()=>setEditingId(null)}
                  onKeyDown={(e)=>{if(e.key==="Enter"){e.preventDefault();setEditingId(null);}}}
                  style={{position:"absolute",left:o.x,top:o.y,width:o.w,height:o.h,background:"transparent",border:"1px dashed gray"}}
                />
              ) : (
                <div key={o.id}
                  className="draggable border border-gray-300"
                  style={{left:o.x,top:o.y,width:o.w,height:o.h}}
                  onMouseDown={(e)=>{ if(e.detail===1) onDrag(o.id,e); }}
                  onDoubleClick={()=>setEditingId(o.id)}
                  onClick={()=>setSelectedIds([o.id])}
                >
                  <div className="editable-text w-full h-full flex items-center justify-center">{o.content}</div>
                  <div className="resize-handle" onMouseDown={(e)=>onResize(o.id,e)}></div>
                </div>
              )
            ))}
          </div>
        </div>
      );
    }

    ReactDOM.render(<App/>, document.getElementById("root"));
  </script>
</body>
</html>
