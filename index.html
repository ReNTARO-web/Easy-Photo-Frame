<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Exif„Éï„É¨„Éº„É†„Ç®„Éá„Ç£„Çø</title>
  <!-- React 17 & Babel -->
  <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- html2canvas -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <!-- exif-js -->
  <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
  <style>
    @font-face {
      font-family: 'CorporateLogo';
      src: url('./Corporate-Logo-Bold-ver3.otf') format('opentype');
    }
    body { font-family: 'CorporateLogo', -apple-system, BlinkMacSystemFont, "Helvetica Neue", "Segoe UI", sans-serif; }
    .draggable { position:absolute; cursor:move; }
    .editable-text { white-space: pre-wrap; text-align: center; }
  </style>
</head>
<body class="bg-gray-100">
  <div id="root"></div>

  <script type="text/babel">

    const { useState, useRef } = React;

    const aspectRatios = {
      "Instagram (1:1)": [600, 600],
      "Twitter (16:9)": [960, 540],
      "YouTube (1280√ó720)": [1280, 720],
      "Facebook (1200√ó630)": [1200, 630],
    };

    function App(){
      const [ratio,setRatio] = useState("Instagram (1:1)");
      const [objects,setObjects] = useState([]);
      const [editingId,setEditingId] = useState(null);
      const containerRef = useRef(null);
      const [cw,ch] = aspectRatios[ratio];
      const snapThreshold = 8;

      // „Çπ„Éä„ÉÉ„Éó
      const snapValue = (val, size, frameSize, others=[]) => {
        const targets = [
          0, frameSize/2 - size/2, frameSize - size,
          ...others
        ];
        for(let t of targets){
          if(Math.abs(val - t) < snapThreshold) return t;
        }
        return val;
      };

      // ÁîªÂÉè„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ
      const handleUpload = (e)=>{
        const files = Array.from(e.target.files);
        files.forEach((file,idx)=>{
          if(!file.type.startsWith("image/")) return;
          const url = URL.createObjectURL(file);

          EXIF.getData(file, function(){
            const make = EXIF.getTag(this,"Make") || "";
            const model = EXIF.getTag(this,"Model") || "";
            const iso = EXIF.getTag(this,"ISOSpeedRatings") || "";
            const exposure = EXIF.getTag(this,"ExposureTime") || "";
            const focal = EXIF.getTag(this,"FocalLength") || "";

            const textContent = `${make} ${model}\nISO ${iso} Èú≤Âá∫ ${exposure} „É¨„É≥„Ç∫ ${focal}`;

            setObjects(prev=>[
              ...prev,
              {id:Date.now()+idx, type:"image", url, x:cw/2-150, y:ch/2-100, w:300, h:200},
              {id:Date.now()+idx+1000, type:"text", content:textContent, x:cw/2-100, y:ch/2+120, w:200, h:60, bold:true, color:"#000", size:16}
            ]);
          });
        });
      };

      // ÁßªÂãï
      const onDrag = (id,e)=>{
        const startX = e.clientX;
        const startY = e.clientY;
        const obj = objects.find(o=>o.id===id);
        const initX = obj.x;
        const initY = obj.y;
        const move = (ev)=>{
          const dx = ev.clientX - startX;
          const dy = ev.clientY - startY;
          const otherObjs = objects.filter(o=>o.id!==id).map(o=>[o.x,o.x+o.w/2,o.x+o.w]);
          const newX = snapValue(initX+dx, obj.w, cw, otherObjs.flat());
          const newY = snapValue(initY+dy, obj.h, ch, []);
          setObjects(prev=>prev.map(o=>o.id===id?{...o,x:newX,y:newY}:o));
        };
        const up = ()=>{
          window.removeEventListener("mousemove",move);
          window.removeEventListener("mouseup",up);
        };
        window.addEventListener("mousemove",move);
        window.addEventListener("mouseup",up);
      };

      // ‰øùÂ≠ò
      const saveAsImage = async ()=>{
        const canvas = await html2canvas(containerRef.current,{scale:2});
        const link = document.createElement("a");
        link.download="workspace.png";
        link.href = canvas.toDataURL("image/png");
        link.click();
      };

      return (
        <div className="flex flex-col items-center p-4 space-y-2">
          <h1 className="text-xl font-bold">üì∏ Exif„Éï„É¨„Éº„É†„Ç®„Éá„Ç£„Çø</h1>
          <div className="flex gap-2">
            {Object.keys(aspectRatios).map(r=>(
              <button key={r} onClick={()=>setRatio(r)} className={`px-2 py-1 ${r===ratio?"bg-blue-500 text-white":"bg-gray-200"}`}>
                {r}
              </button>
            ))}
          </div>
          <input type="file" accept="image/*" multiple onChange={handleUpload} />
          <button onClick={saveAsImage} className="px-3 py-1 bg-green-500 text-white">‰øùÂ≠ò</button>

          <div ref={containerRef} className="relative bg-white border shadow"
            style={{width:cw,height:ch}}>
            {objects.map(o=>(
              editingId===o.id ? (
                <textarea key={o.id} autoFocus value={o.content}
                  onChange={(e)=>setObjects(prev=>prev.map(x=>x.id===o.id?{...x,content:e.target.value}:x))}
                  onBlur={()=>setEditingId(null)}
                  onKeyDown={(e)=>{if(e.key==="Enter"){e.preventDefault();setEditingId(null);}}}
                  style={{position:"absolute",left:o.x,top:o.y,width:o.w,height:o.h,background:"transparent",border:"1px dashed gray",textAlign:"center",fontFamily:"CorporateLogo",fontSize:o.size,color:o.color,fontWeight:o.bold?"bold":"normal"}}
                />
              ) : (
                <div key={o.id}
                  className="draggable flex items-center justify-center"
                  style={{left:o.x,top:o.y,width:o.w,height:o.h,textAlign:"center",position:"absolute"}}
                  onMouseDown={(e)=>{ if(e.detail===1) onDrag(o.id,e); }}
                  onDoubleClick={()=>setEditingId(o.id)}
                >
                  {o.type==="image" ? <img src={o.url} className="w-full h-full object-contain"/> :
                    <div className="editable-text w-full h-full flex flex-col justify-center"
                      style={{fontFamily:"CorporateLogo",fontSize:o.size,color:o.color,fontWeight:o.bold?"bold":"normal"}}>
                      {o.content}
                    </div>
                  }
                </div>
              )
            ))}
          </div>
        </div>
      );
    }

    ReactDOM.render(<App/>, document.getElementById("root"));
  </script>
</body>
</html>
