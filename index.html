<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>写真フレームエディタ</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    body { font-family: sans-serif; }
    .editable-text {
      cursor: text;
      white-space: pre-wrap;
      word-break: break-word;
    }
  </style>
</head>
<body class="bg-gray-100">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useRef, useEffect } = React;

    // SNS/印刷用の比率リスト
    const aspectRatios = {
      "Instagram (1:1)": [800, 800],
      "Twitter (16:9)": [1280, 720],
      "YouTube (1280×720)": [1280, 720],
      "Facebook (1200×630)": [1200, 630],
      "A4縦 (210×297)": [794, 1123],
      "A4横 (297×210)": [1123, 794],
      "汎用 (4:3)": [1024, 768],
      "汎用 (3:2)": [1200, 800],
    };

    function App() {
      const [ratio, setRatio] = useState("Instagram (1:1)");
      const [photos, setPhotos] = useState([]);
      const [texts, setTexts] = useState([
        { id: 1, content: "ここをダブルクリックして編集", x: 50, y: 50 }
      ]);
      const [editingId, setEditingId] = useState(null);
      const containerRef = useRef(null);

      const [cw, ch] = aspectRatios[ratio];

      // 写真アップロード
      const handleUpload = (e) => {
        const files = Array.from(e.target.files);
        files.forEach((file, idx) => {
          if (!file.type.startsWith("image/")) return;
          const url = URL.createObjectURL(file);
          setPhotos((prev) => [...prev, {
            id: Date.now()+idx, url, x: 50, y: 100+idx*40, w:300, h:200
          }]);
        });
      };

      // 保存
      const saveAsImage = async () => {
        const canvas = await html2canvas(containerRef.current, { scale: 2 });
        const link = document.createElement("a");
        link.download = "workspace.png";
        link.href = canvas.toDataURL("image/png");
        link.click();
      };

      // テキスト更新
      const handleTextChange = (id, value) => {
        setTexts((prev) => prev.map((t) =>
          t.id === id ? { ...t, content: value } : t
        ));
      };

      return (
        <div className="p-6 space-y-4">
          <h1 className="text-2xl font-bold">📷 写真フレームエディタ</h1>

          {/* コントロール */}
          <div className="flex flex-wrap gap-2">
            {Object.keys(aspectRatios).map((r) => (
              <button key={r} onClick={() => setRatio(r)}
                className={`px-3 py-1 rounded ${r===ratio ? "bg-blue-500 text-white":"bg-gray-200"}`}>
                {r}
              </button>
            ))}
          </div>

          <input type="file" accept="image/*" multiple onChange={handleUpload} />

          <button onClick={saveAsImage} className="px-4 py-2 bg-green-500 text-white rounded">
            保存
          </button>

          {/* ワークスペース */}
          <div ref={containerRef} className="relative bg-white border shadow"
            style={{ width:cw, height:ch }}>
            
            {/* 写真配置 */}
            {photos.map((p) => (
              <img key={p.id} src={p.url}
                style={{ position:"absolute", left:p.x, top:p.y, width:p.w, height:p.h }}
              />
            ))}

            {/* テキスト配置 */}
            {texts.map((t) => (
              editingId === t.id ? (
                <textarea
                  key={t.id}
                  autoFocus
                  value={t.content}
                  onChange={(e) => handleTextChange(t.id, e.target.value)}
                  onBlur={() => setEditingId(null)}
                  style={{
                    position: "absolute",
                    left: t.x,
                    top: t.y,
                    minWidth: "200px",
                    background: "transparent",
                    border: "1px dashed gray",
                  }}
                />
              ) : (
                <div
                  key={t.id}
                  className="editable-text absolute"
                  style={{ left: t.x, top: t.y }}
                  onDoubleClick={() => setEditingId(t.id)}
                >
                  {t.content}
                </div>
              )
            ))}
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>
