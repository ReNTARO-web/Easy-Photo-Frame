<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Exif„Éï„É¨„Éº„É†„Ç®„Éá„Ç£„Çø</title>
  <!-- React 17 & Babel -->
  <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- html2canvas -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <!-- exif-js -->
  <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", "Segoe UI", sans-serif; }
    .draggable { position:absolute; cursor:move; }
    .resize-handle { width:10px;height:10px;background:#2563eb;position:absolute;right:-5px;bottom:-5px;cursor:se-resize; }
    .editable-text { white-space: pre-wrap; text-align: center; }
  </style>
</head>
<body class="bg-gray-100">
  <div id="root"></div>

  <script type="text/babel">

    const { useState, useRef } = React;

    const aspectRatios = {
      "Instagram (1:1)": [600, 600],
      "Twitter (16:9)": [960, 540],
      "YouTube (1280√ó720)": [1280, 720],
      "Facebook (1200√ó630)": [1200, 630],
    };

    function App(){
      const [ratio,setRatio] = useState("Instagram (1:1)");
      const [objects,setObjects] = useState([]);
      const [editingId,setEditingId] = useState(null);
      const containerRef = useRef(null);
      const [cw,ch] = aspectRatios[ratio];
      const snapThreshold = 10; // „Çπ„Éä„ÉÉ„ÉóÊÑüÂ∫¶

      // „Çπ„Éä„ÉÉ„ÉóÂá¶ÁêÜÔºà‰∏≠ÂøÉ„ÉªÁ´ØÔºâ
      const snapValue = (val, size, frameSize) => {
        const targets = [
          0,                            // Â∑¶ or ‰∏äÁ´Ø
          frameSize/2 - size/2,         // ‰∏≠Â§Æ
          frameSize - size              // Âè≥ or ‰∏ãÁ´Ø
        ];
        for(let t of targets){
          if(Math.abs(val - t) < snapThreshold) return t;
        }
        return val;
      };

      // „Éï„Ç°„Ç§„É´„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ
      const handleUpload = (e)=>{
        const files = Array.from(e.target.files);
        files.forEach((file,idx)=>{
          if(!file.type.startsWith("image/")) return;
          const url = URL.createObjectURL(file);

          // EXIFË™≠„ÅøËæº„Åø
          EXIF.getData(file, function(){
            const make = EXIF.getTag(this,"Make") || "";
            const model = EXIF.getTag(this,"Model") || "";
            const iso = EXIF.getTag(this,"ISOSpeedRatings") || "";
            const exposure = EXIF.getTag(this,"ExposureTime") || "";
            const focal = EXIF.getTag(this,"FocalLength") || "";

            const textContent = `${make} ${model}\nISO ${iso} Èú≤Âá∫ ${exposure} „É¨„É≥„Ç∫ ${focal}`;

            // ÁîªÂÉè„Å®„ÉÜ„Ç≠„Çπ„Éà„Çí„Éï„É¨„Éº„É†‰∏≠Â§Æ„Å´ÈÖçÁΩÆ
            setObjects(prev=>[
              ...prev,
              {id:Date.now()+idx, type:"image", url, x:cw/2-150, y:ch/2-100, w:300, h:200},
              {id:Date.now()+idx+1000, type:"text", content:textContent, x:cw/2-100, y:ch/2+120, w:200, h:60}
            ]);
          });
        });
      };

      // ÁßªÂãï
      const onDrag = (id,e)=>{
        const startX = e.clientX;
        const startY = e.clientY;
        const obj = objects.find(o=>o.id===id);
        const initX = obj.x;
        const initY = obj.y;
        const move = (ev)=>{
          const dx = ev.clientX - startX;
          const dy = ev.clientY - startY;
          const newX = snapValue(initX+dx, obj.w, cw);
          const newY = snapValue(initY+dy, obj.h, ch);
          setObjects(prev=>prev.map(o=>o.id===id?{...o,x:newX,y:newY}:o));
        };
        const up = ()=>{
          window.removeEventListener("mousemove",move);
          window.removeEventListener("mouseup",up);
        };
        window.addEventListener("mousemove",move);
        window.addEventListener("mouseup",up);
      };

      // „Çµ„Ç§„Ç∫Â§âÊõ¥
      const onResize = (id,e)=>{
        e.stopPropagation();
        const startX = e.clientX;
        const startY = e.clientY;
        const obj = objects.find(o=>o.id===id);
        const initW = obj.w;
        const initH = obj.h;
        const move = (ev)=>{
          const dw = ev.clientX - startX;
          const dh = ev.clientY - startY;
          const newW = Math.max(30,initW+dw);
          const newH = Math.max(20,initH+dh);
          setObjects(prev=>prev.map(o=>o.id===id?{...o,w:newW,h:newH}:o));
        };
        const up = ()=>{
          window.removeEventListener("mousemove",move);
          window.removeEventListener("mouseup",up);
        };
        window.addEventListener("mousemove",move);
        window.addEventListener("mouseup",up);
      };

      // ‰øùÂ≠òÔºà„Éè„É≥„Éâ„É´ÈùûË°®Á§∫Ôºâ
      const saveAsImage = async ()=>{
        const handles = document.querySelectorAll(".resize-handle");
        handles.forEach(h=>h.style.display="none");

        const canvas = await html2canvas(containerRef.current,{scale:2});
        const link = document.createElement("a");
        link.download="workspace.png";
        link.href = canvas.toDataURL("image/png");
        link.click();

        handles.forEach(h=>h.style.display="block");
      };

      return (
        <div className="flex flex-col items-center p-4 space-y-2">
          <h1 className="text-xl font-bold">üì∏ Exif„Éï„É¨„Éº„É†„Ç®„Éá„Ç£„Çø</h1>
          <div className="flex gap-2">
            {Object.keys(aspectRatios).map(r=>(
              <button key={r} onClick={()=>setRatio(r)} className={`px-2 py-1 ${r===ratio?"bg-blue-500 text-white":"bg-gray-200"}`}>
                {r}
              </button>
            ))}
          </div>
          <input type="file" accept="image/*" multiple onChange={handleUpload} />
          <button onClick={saveAsImage} className="px-3 py-1 bg-green-500 text-white">‰øùÂ≠ò</button>

          <div ref={containerRef} className="relative bg-white border shadow"
            style={{width:cw,height:ch}}>
            {objects.map(o=>(
              editingId===o.id ? (
                <textarea key={o.id} autoFocus value={o.content}
                  onChange={(e)=>setObjects(prev=>prev.map(x=>x.id===o.id?{...x,content:e.target.value}:x))}
                  onBlur={()=>setEditingId(null)}
                  onKeyDown={(e)=>{if(e.key==="Enter"){e.preventDefault();setEditingId(null);}}}
                  style={{position:"absolute",left:o.x,top:o.y,width:o.w,height:o.h,background:"transparent",border:"1px dashed gray",textAlign:"center"}}
                />
              ) : (
                <div key={o.id}
                  className="draggable border border-gray-300 flex items-center justify-center"
                  style={{left:o.x,top:o.y,width:o.w,height:o.h,textAlign:"center"}}
                  onMouseDown={(e)=>{ if(e.detail===1) onDrag(o.id,e); }}
                  onDoubleClick={()=>setEditingId(o.id)}
                >
                  {o.type==="image" ? <img src={o.url} className="w-full h-full object-contain"/> :
                    <div className="editable-text w-full h-full flex flex-col justify-center">
                      <span className="font-bold">{o.content.split("\n")[0]}</span>
                      <span>{o.content.split("\n").slice(1).join("\n")}</span>
                    </div>
                  }
                  <div className="resize-handle" onMouseDown={(e)=>onResize(o.id,e)}></div>
                </div>
              )
            ))}
          </div>
        </div>
      );
    }

    ReactDOM.render(<App/>, document.getElementById("root"));
  </script>
</body>
</html>
